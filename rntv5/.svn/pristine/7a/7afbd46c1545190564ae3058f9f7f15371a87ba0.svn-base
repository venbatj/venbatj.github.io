<!DOCTYPE html>

<html lang="en" data-ng-app="RAT">
    <!-- BEGIN HEAD -->
    <head>
        <title>Rent A Towel | Activation</title>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta content="width=device-width, initial-scale=1" name="viewport" />
        <meta content="Rent A Towel" name="description" />
        <meta content="RAT" name="author" />

        <!-- BEGIN GLOBAL MANDATORY STYLES -->

        <!-- FONT ICONS --> 
        <link href="../assets/global/fonts/roboto/font.css" rel="stylesheet" type="text/css" />
        <link href="../assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

        <link href="../assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="../assets/global/css/plugins.min.css" rel="stylesheet" type="text/css" />
           
        <!-- END GLOBAL MANDATORY STYLES -->
        <!-- BEGIN DYMANICLY LOADED CSS FILES(all plugin and page related styles must be loaded between GLOBAL and THEME css files ) -->
        <link id="ng_load_plugins_before" />
        <!-- END DYMANICLY LOADED CSS FILES -->
        <!-- BEGIN THEME STYLES -->
        <!-- DOC: To use 'rounded corners' style just load 'components-rounded.css' stylesheet instead of 'components.css' in the below style tag -->
        <link href="../assets/global/css/components.css" id="style_components" rel="stylesheet" type="text/css" />
        <!-- PAGE LAYOUTS -->
        <link href="css/layout.css" rel="stylesheet" type="text/css" />
        <!-- THEME -->
        <link href="css/themes/blue.css" rel="stylesheet" type="text/css" id="style_color" />
        <link href="css/custom.css" rel="stylesheet" type="text/css" />
        <link href="../app/css/page/login.css" rel="stylesheet" type="text/css" />
        
        <!-- END THEME STYLES -->
        <link rel="shortcut icon" href="favicon.ico" /> 
    </head>
    <!-- END HEAD -->

    <body class=" login">
        <!-- BEGIN LOGO -->
        <div class="logo">
            <a href="index.html">
                <img src="img/rentatowel-logo.png" alt="" /> </a>
        </div>
        <!-- END LOGO -->
        <!-- BEGIN ACTIVATION -->
        <div class="content">
            <!-- BEGIN ACTIVATION FORM -->
            <form class="login-form" style="min-height: 280px;" id="form">
                <h3 class="form-title">What password, could you like to have?</h3>
                <div class="alert alert-danger display-hide">
                    <button class="close" data-close="alert"></button>
                    <span class="login-error-txt"> Enter a password.</span>
                </div>
                <div class="form-group">
                    <label class="control-label visible-ie8 visible-ie9">Password</label>
                    <label>Password</label>
                    <div class="input-icon">
                        <i class="fa fa-lock"></i>
                        <input id="Password" name="Password" class="form-control placeholder-no-fix" type="password" autocomplete="off" placeholder="Password" required/>
                        <span class="fa fa-lg fa-eye field-icon" onmouseover="mouseoverPass();" onmouseout="mouseoutPass();"></span>
                
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label visible-ie8 visible-ie9">Confirm Password</label>
                    <label>Confirm Password</label>
                    <div class="input-icon">
                        <i class="fa fa-lock"></i>
                        <input id="ConfirmPassword" name="ConfirmPassword" data-rule-equalTo="#Password" class="form-control placeholder-no-fix" type="password" 
                        autocomplete="off" placeholder="Confirm Password" required/> 
                       
                    </div>
                </div>
                <!-- <input name="LoginID" id="LoginID" type="hidden" value="" /> -->
                <input name="ref" id="ref" type="hidden" value="" />
                <input name="code" id="code" type="hidden" value="" />
                <div class="form-group">
                    <span class="error" style="color:red"></span><br />
                </div>
                <div class="form-actions">
                    <button id="submit-btn" type="button" class="btn green pull-right submit-btn"> Submit </button>
                </div>
            </form>
            <!-- END ACTIVATION FORM -->
        </div>
        <!-- END LOGIN -->
        <!-- BEGIN COPYRIGHT -->
        <div class="copyright"> 2019 &copy; RNT - Rent A Towel. </div>
        <!-- END COPYRIGHT -->
        <!--[if lt IE 9]>
        <script src="../assets/global/plugins/respond.min.js"></script>
        <script src="../assets/global/plugins/excanvas.min.js"></script> 
        <script src="../assets/global/plugins/ie8.fix.min.js"></script> 
        <![endif]-->
        <!-- BEGIN CORE PLUGINS -->
        <script src="../assets/global/plugins/jquery.min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>

        <script src="../assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
        <!-- END CORE PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <script src="../assets/global/plugins/jquery-validation/js/jquery.validate.min.js" type="text/javascript"></script>
        <script src="../assets/global/plugins/jquery-validation/js/additional-methods.min.js" type="text/javascript"></script>
        <script src="../assets/global/plugins/backstretch/jquery.backstretch.min.js" type="text/javascript"></script>
        <!-- END PAGE LEVEL PLUGINS -->
        
        <script>
            $(document).ready(function() {
                // init background slide images
                url = new URL(window.location);
                var ActivationCode = url.searchParams.get('activate-code');
                var ID = url.searchParams.get('ref');

                $.backstretch([
                        '../assets/pages/media/bg/1.jpg',
                        '../assets/pages/media/bg/2.jpg'/*,
                        '../assets/pages/media/bg/3.jpg',
                        '../assets/pages/media/bg/4.jpg'*/
                    ], {
                        fade: 1000,
                        duration: 8000
                    }
                );

                var redirect = true;
                if (window.location.search.substring(1)) {
                    var urlParms = window.location.search.substring(1).split('&');
                    if (urlParms != null && urlParms.length > 0) {
                        var parms = {};
                        $.each(urlParms, function() {
                            if (this != null && this != '') {
                                var parmArr = this.split('=');
                                if (parmArr.length == 2)
                                    parms[parmArr[0]] = parmArr[1];
                            }
                        });
                        
                        if (parms['code'] && parms['code'] != '')
                            document.getElementById('code').value = parms['code'];
                        else
                            redirect = false;
                        
                        if (parms['ref'] && parms['ref'] != '')
                            document.getElementById('ref').value = parms['ref'];
                        else
                            redirect = false;

                        if (!redirect) {
                            
                        } 
                        // else
                            // window.location.href = 'index.html';
                    } 
                    // else
                        // window.location.href = 'index.html';
                } 
                // else
                    // window.location.href = 'index.html';
                
                var Path = window.location.pathname;
                var APIPath = window.location.origin + Path.replace('/app/', '/services/').replace('activate.html', '') + 'api.php';

                $('body').bind('cut copy paste', function (e) {
                    e.preventDefault();
                });

                var submit = false;
                $(function(){
                    $('#ConfirmPassword').keyup(function(e){
                        var Password = $('#Password').val();
                        var ConfirmPassword = $(this).val();
                        
                        if(Password == ConfirmPassword){
                            $('.error').text('');
                            submit = true;
                        }else{
                            submit = false;
                        }
                    });
                    
                    $('#form').submit(function(){
                        var Password = $('#Password').val();
                        var ConfirmPassword = $('#ConfirmPassword').val();
        
                        if(Password == ConfirmPassword){
                            submit = true;
                        }
                        if(submit){
                            return true;
                        }else{
                            return false;
                        }
                    });
                });

                if (ActivationCode != null) {
                    $.ajax({
						url: APIPath,
						type: 'POST',
						data: {
							EndPoint: 'Account/Authenticate/loadPage',
                            ActivationCode: ActivationCode, 
                            Ref: ID
						},
                        success: function(Res) {
                            var Res = JSON.parse(Res);   
                            if (Res.S) {
                                console.log(Res.D.ID);
                                if (Res.D.Flag == 'A') {
                                    alert("Already the invite has been accepted, please login using the credentials");
                                    window.location.href = 'index.html';
                                } else if (Res.D.Flag == 'R') {
                                    alert("Please contact the administrator admin@rnt.com");
                                    window.location.href = 'index.html';
                                } else {
                                    var ref = Res.D.ID;
                                    if (ref == undefined || ref == null) {
                                        alert("Invalid activation or reference code");
                                        window.location.href = 'index.html';
                                    }
                                }
                            }
                        }
                    });
                }

                $('#submit-btn').click(function() {
                    if ($('.login-form').valid()) {
                        $.ajax({
                            url: APIPath,
                            type: 'POST',
                            data: {
                                EndPoint: 'Account/Authenticate/activate',
                                Password: $('#Password').val(),
                                ActivationCode: ActivationCode,
                                Ref: ID
                            },
                            success: function(Res) {
                                $("#submit-btn").prop('disabled', false);
                                var Res = JSON.parse(Res);
                                if (Res.S) {
                                    alert('Password set successfully, please login to your account');
                                    window.location.href = 'index.html';
                                } else {
                                    alert(Res.M);
                                }
                            }
                        });
                    }
                });
            });

            function mouseoverPass(obj) {
                var obj = document.getElementById('Password');
                obj.type = "text";
            }
            function mouseoutPass(obj) {
                var obj = document.getElementById('Password');
                obj.type = "password";
            }
        </script>
    </body>
    <!-- END BODY -->
</html>